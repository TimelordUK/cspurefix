name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for changelog generation

    - name: Get previous tag
      id: prev_tag
      run: |
        CURRENT_TAG="${{ github.ref_name }}"
        # Get the previous tag (excluding current)
        PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${CURRENT_TAG}$" | head -n1)
        if [ -z "$PREV_TAG" ]; then
          # No previous tag, use first commit
          PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          echo "No previous tag found, using first commit: $PREV_TAG"
        else
          echo "Previous tag: $PREV_TAG"
        fi
        echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

    - name: Generate release notes
      id: release_notes
      run: |
        CURRENT_TAG="${{ github.ref_name }}"
        PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"

        echo "Generating changelog from $PREV_TAG to $CURRENT_TAG"

        # Generate changelog
        {
          echo "## What's Changed"
          echo ""
          git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges
          echo ""
          echo ""
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${CURRENT_TAG}"
        } > release_notes.md

        cat release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: ${{ github.ref_name }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
